# unity-webgl

Unity WebGL provides an easy solution for embedding Unity WebGL builds in your webApp or `Vue.js` project, with two-way communication between your webApp and Unity application with advanced API's.   

UnityWebgl.js æä¾›äº†ä¸€ç§ç®€å•çš„è§£å†³æ–¹æ¡ˆï¼Œç”¨äºåœ¨ webApp æˆ– Vue.js ï¼ˆæ”¯æŒ`Vue2.x` & `Vue3.x`ï¼‰ é¡¹ç›®ä¸­åµŒå…¥ Unity WebGLï¼Œå¹¶é€šè¿‡APIåœ¨ webApp å’Œ Unity ä¹‹é—´è¿›è¡ŒåŒå‘é€šä¿¡ã€‚

based on [react-unity-webgl](https://github.com/jeffreylanters/react-unity-webgl)

## Features
- ğŸ’Š Simple and flexible to use
- ğŸ“® two-way communication (`webApp`, `Unity`)
- ğŸ›  Built-in event handler
- ğŸ§¬ Available for `Vue.js` ([Vue@2.x](https://jake.stackblitz.com/edit/unity-webgl-vue2-demo?file=src%2FApp.vue) & [Vue@3.x](https://stackblitz.com/edit/unity-webgl-vue3-demo?file=src/App.vue))

## API

### Unity Config

* `loaderUrl: string` The url to the build json file generated by Unity
* `dataUrl: string` :  The url to the build data file generated by Unity
* `frameworkUrl: string` :  The url to the framework file generated by Unity
* `codeUrl: string` :  The url to the unity code file generated by Unity
* `streamingAssetsUrl?: string` :  The url where the streaming assets can be found
* `companyName?: string` :  The applications company name
* `productName?: string` :  The applications product name
* `productVersion?: string` :  The applications product version
* `webglContextAttributes?: IWebGLContextAttributes` :  This object allow you to configure WebGLRenderingContext creation options. see [MDN@WebGLRenderingContext](https://developer.mozilla.org/en-US/docs/Web/API/WebGLRenderingContext/getContextAttributes)
* `devicePixelRatio?: number` :  Uncomment this to override low DPI rendering on high DPI displays. see [MDN@devicePixelRatio](https://developer.mozilla.org/en-US/docs/Web/API/Window/devicePixelRatio)
* `matchWebGLToCanvasSize?: boolean` :  Uncomment this to separately control WebGL canvas render size and DOM element size. see [unity3d@matchWebGLToCanvasSize](https://issuetracker.unity3d.com/issues/webgl-builds-dont-allow-separate-control-on-canvas-render-buffer-size)

### Unity Instance

**Methodsï¼š**

* `on(eventName: string, eventListener: function)`
* `once(eventName: string, eventListener: function)`
* `off(eventName: string)`
* `clear()`
* `emit(eventName: string)`

---

* `create(canvasElement: HTMLCanvasElement | string)`
* `send(objectName: string, methodName: string, params: any)`
* `setFullscreen()`
* `destroy()`

**Eventsï¼š**

- `progress(value: number)` : loading progress.
- `loaded()` : loading completed.
- `created()` : Unity instance is created.
- `destroyed()` : Quits the Unity Instance and clears it from memory.

### vue component

**props**

* `unity: UnityWebgl`
* `width?: string|number ` , default: `100%`
* `height?: string|number ` , default: `100%`

## Install
```
npm install unity-webgl
```

browser
```
https://cdn.jsdelivr.net/npm/unity-webgl/dist/UnityWebgl.min.js
```

## Usage

in example.html:

```html
<canvas id="canvas" style="width: 100%; height: 100%"></canvas>

<button onclick="onDestroy()">Destroy</button>
<button onclick="onLoad()">Reload</button>
<button onclick="onFullscreen()">Fullscreen</button>

<script>
var Unity = new UnityWebgl('#canvas', {
  loaderUrl: '/Build/unity.loader.js',
  dataUrl: "/Build/unity.data",
  frameworkUrl: "/Build/unity.framework.js",
  codeUrl: "/Build/unity.wasm"
})

Unity
  .on('progress', percent => console.log('Unity Loaded: ', percent))
  .on('created', () => console.log('Unity Instance: created.'))
  .on('destroyed', () => console.log('Unity Instance: Destroyed.'))

function postMessage() {
  Unity.send('objectName', 'methodName', {
    id: 'B0001',
    name: 'Building#1',
    location: [150, 75]
  })
}

function onDestroy() {
  Unity.destroy()
}

function onLoad() {
  Unity.create('#canvas')
}

function onFullscreen() {
  Unity.setFullscreen(true)
}
</script>
```

You can also:

```js
var Unity = new UnityWebgl({
  loaderUrl: '/Build/unity.loader.js',
  dataUrl: "/Build/unity.data",
  frameworkUrl: "/Build/unity.framework.js",
  codeUrl: "/Build/unity.wasm",
  streamingAssetsUrl: "StreamingAssets",
  companyName: "DefaultCompany",
  productName: "Unity",
  productVersion: "0.1",
})

Unity.create(document.querySelector('#canvas'))
```

### Vue

* [Vue@2.x example](https://jake.stackblitz.com/edit/unity-webgl-vue2-demo?file=src%2FApp.vue)
* [Vue@3.x example](https://stackblitz.com/edit/unity-webgl-vue3-demo?file=src/App.vue)

in example.vue

```html
<template>
  <Unity :unity="unityContext" width="800px" height="600px" />
</template>

<script>
import UnityWebgl from 'unity-webgl'

const Unity = new UnityWebgl({
  loaderUrl: '/Build/unity.loader.js',
  dataUrl: "/Build/unity.data",
  frameworkUrl: "/Build/unity.framework.js",
  codeUrl: "/Build/unity.wasm"
})

export default {
  name: 'Unity',
  components: {
    Unity: UnityWebgl.vueComponent
  },
  data() {
    return {
      unityContext: Unity
    }
  }
}
</script>
```

## Communication

* [**WebGL: Interacting with browser scripting**@Unity3d.Docs](https://docs.unity3d.com/Manual/webgl-interactingwithbrowserscripting.html)
* [**WebGLï¼šä¸æµè§ˆå™¨è„šæœ¬äº¤äº’**@Unity3då®˜æ–¹æ–‡æ¡£](https://docs.unity3d.com/cn/2020.3/Manual/webgl-interactingwithbrowserscripting.html)

### 1. Calling JavaScript functions from Unity scripts

**ä» Unity è„šæœ¬è°ƒç”¨ JavaScript å‡½æ•°**

1. First, you should register a `showDialog` method, which be bind to the `__UnityLib__` global object by default.

   å…ˆåœ¨å‰ç«¯é¡¹ç›®ä¸­é€šè¿‡ `Unity.on()` æ³¨å†Œ `showDialog` æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šé»˜è®¤ç»‘å®šåœ¨å…¨å±€å¯¹è±¡`__UnityLib__`ä¸Šã€‚

```js
// # in webApp

const Unity = new UnityWebgl()
// Register functions
Unity.on('showDialog', (data) => {
  console.log(data)
  $('#dialog').show()
})

// you also can call function.
Unity.emit('showDialog', data)
// or
window[Unity.global_name].showDialog(data) // ğŸ“¢ Unity.global_name = __UnityLib__
```

2. In the Unity project, add the registered `showDialog` method to the project, and then call those functions directly from your script code. To do so, place files with JavaScript code using the `.jslib` extension under a â€œPluginsâ€ subfolder in your Assets folder. The plugin file needs to have a syntax like this:

   åœ¨Unityé¡¹ç›®ä¸­ï¼Œå°†æ³¨å†Œçš„`showDialog`æ–¹æ³•æ·»åŠ åˆ°é¡¹ç›®ä¸­ã€‚æ³¨æ„ğŸ“¢ ï¼šè¯·ä½¿ç”¨ `.jslib` æ‰©å±•åå°†åŒ…å« JavaScript ä»£ç çš„æ–‡ä»¶æ”¾ç½®åœ¨ Assets æ–‡ä»¶å¤¹ä¸­çš„â€œPluginsâ€å­æ–‡ä»¶å¤¹ä¸‹ã€‚æ’ä»¶æ–‡ä»¶éœ€è¦æœ‰å¦‚ä¸‹æ‰€ç¤ºçš„è¯­æ³•ï¼š

```js
// javascript_extend.jslib

mergeInto(LibraryManager.library, {
  // this is you code
  showDialog: function (str) {
    var data = Pointer_stringify(str);
    // '__UnityLib__' is a global function collection.
    __UnityLib__.showDialog(data);
  },
  
  Hello: function () {
    window.alert("Hello, world!");
  }
});
```

Then you can call these functions from your C# scripts like this:

```c#
using UnityEngine;
using System.Runtime.InteropServices;

public class NewBehaviourScript : MonoBehaviour {

    [DllImport("__Internal")]
    private static extern void Hello();

    [DllImport("__Internal")]
    private static extern void showDialog(string str);

    void Start() {
        Hello();
        
        showDialog("This is a string.");
    }
}
```

### 2. Calling Unity scripts functions from JavaScript

ä½¿ç”¨ JavaScript è°ƒç”¨ Unity è„šæœ¬å‡½æ•°

```js
const Unity = new UnityWebgl()

/**
 * Sends a message to the UnityInstance to invoke a public method.
 * @param {string} objectName Unity scene name.
 * @param {string} methodName public method name.
 * @param {any} params an optional method parameter.
 */
Unity.send(objectName, methodName, params)

// e.g. Initialize Building#001 data
Unity.send('mainScene', 'init', {
  id: 'b001',
  name: 'building#001',
  length: 95,
  width: 27,
  height: 120
})
```

